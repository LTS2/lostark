<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8"/>
    <title>모집글 상세 보기</title>
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, minimum-scale=1.0, initial-scale=1.0"/>
    <link rel="stylesheet" href="/css/recruitment/recruitment.css"/> <!-- 스타일 시트 경로 -->
    <th:block th:replace="~{fragments/config::configFragment}"></th:block>
    <link rel="stylesheet" th:href="@{/css/recruitment/detail.css}">
</head>

<body>
<!-- Header -->
<th:block th:replace="~{fragments/header :: headerFragment}"></th:block>

<main style="margin-top: 20px;" id="reside-con">
    <!-- Main Content -->
    <section class="content" id="activity-content">
        <div>
            <h1>모집글 상세 보기</h1>
        </div>
        <div class="writer-con">
            <div class="profile-picture">
                <img th:src="${recruitment.user.picture != null} ? @{${recruitment.user.picture}} : @{/images/default.jpg}"
                     th:alt="${recruitment.user.picture != null} ? '프로필 사진' : '기본 프로필 사진'"
                     class="profile-img"
                     id="current-profile-image" />
            </div>

            <div class="writer-info">
                <span class="writer-name">작성자 : </span>
                <span class="writer-username" th:text="${recruitment.user.username}"></span>
            </div>

            <br>

            <div class="guestbook-button">

                <button type="button"
                        class="write-guestbook-btn"
                        th:if="${session.user == null}"
                        onclick="alert('로그인 후 이용해주세요');">
                    방명록 작성
                </button>

                <button type="button"
                        class="write-guestbook-btn"
                        th:if="${session.user != null}"
                        onclick="openModal()">
                    방명록 작성
                </button>
            </div>
        </div>
        <!-- 방명록 작성 모달창 -->
        <div id="guestbook-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="dashboard-write">
                    <div class="guest-textarea">
                        <label for="guestbook-comment" class="screen_out">방명록 작성</label>
                        <textarea id="guestbook-comment" placeholder="내용을 입력하세요." class="guest-textarea-input"></textarea>
                        <div class="guest-submit-con">
                            <button type="submit" class="guest-submit-btn" onclick="submitGuestbook()">등록</button>
                        </div>
                    </div>
                    <br>
                    <button class="modal-close" onclick="closeModal()">닫기</button>
                </div>
            </div>
        </div>

        <div th:if="${session.user != null}">
            <input type="hidden" id="username" th:value="${session.user.getUsername()}">
            <input type="hidden" id="userId" th:value="${session.user.getId()}">
        </div>

        <!-- 모집글 작성자 아이디 -->
        <input type="hidden" id="targetUserId" th:value="${recruitment.getUser().getId()}">

        <div class="details-box">
            <!-- 모집글 상세 보기 -->
            <div class="status-con">
                <h3 th:text="${recruitment.status} + '(' + ${recruitment.applyCount} + '/' + ${recruitment.recruitmentCount} + ')'"></h3>
                <div>
                    <span th:text="${recruitment.goal != null ? recruitment.goal : '정보 없음'}"></span> |
                    <span th:text="${recruitment.startDate != null ? recruitment.startDate : '정보 없음'}"> </span> |
                    <span th:text="${recruitment.challengeTime != null ? recruitment.challengeTime : '정보 없음'}"></span> |
                    <span th:text="${recruitment.proficiency != null ? recruitment.proficiency : '정보 없음'}"></span>
                </div>
            </div>
            <br>
            <div class="details-title" th:if="${recruitment != null}" th:text="${recruitment.title}">제목</div>
            <div class="details-content">
                <div class="box-container">
                    <div th:each="i : ${#numbers.sequence(1, recruitment.recruitmentCount)}"
                         th:with="team=${recruitmentTeams.size() >= i ? recruitmentTeams[i-1] : null}"
                         th:class="${team != null ? 'box' : 'box empty-box'}">
                        <!-- 지원자가 있는 경우 -->
                        <div th:if="${team != null}" class="apply-container">
                            <h3 th:text="${team.user.username}"></h3>
                            <p th:text="'아이템 레벨: ' + ${team.characterEntity.itemAvgLevel}">아이템 레벨</p>
                        </div>
                        <!-- 지원자가 없는 경우 -->
                        <div th:unless="${team != null}">
                            <p>빈 자리</p>
                        </div>
                    </div>
                </div>

                <form id="character-form" action="/api/recruitment/submit-character" method="POST">
                    <input type="hidden" id="selected-character" name="selectedCharacter">
                    <input type="hidden" id="recruitment-id" name="recruitmentId" th:value="${recruitment.id}">
                    <div th:each="team : ${recruitmentTeams}" class="form-div">
                        <div th:if="${session.user != null} and ${team.user.id == session.user.getId()}">
                            <a href="#" id="apply-btn" class="disabled" th:text="'지원완료'"></a>
                        </div>

                        <div th:if="${session.user != null} and ${team.user.id != session.user.getId()}" class="form-div">
                            <a href="#" id="apply-btn"
                               th:onclick="${session.user != null} ? 'showCharacterModal()' : 'alert(\'로그인 후 이용해주세요\')'"
                               th:text="'지원하기'"></a>
                        </div>
                    </div>

                </form>

                <div id="character-modal" class="character-modal">
                    <div class="character-content">
                        <span class="character-close-btn" onclick="closeCharacterModal()">&times;</span>
                        <h2>지원할 캐릭터 선택</h2>
                        <select id="character-select">
                            <option value="" disabled selected>캐릭터를 선택하세요</option>
                            <option th:each="character : ${characterList}"
                                    th:value="${character.id}"
                                    th:text="${character.characterName}">
                            </option>
                        </select>

                        <div class="apply-div">
                         <button onclick="applyCharacter()">확인</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="/js/recruitment/recruitment.js"></script>
<script th:src="@{/js/recruitment/detail.js}"></script>

<!-- Footer -->
<th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>
</body>
</html>